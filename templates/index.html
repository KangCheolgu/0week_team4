<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>post page</title>

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <!-- 구글 폰트(예정) -->

    <!-- 폰트 어썸 아이콘 -->
    <script
      src="https://kit.fontawesome.com/612dc86cae.js"
      crossorigin="anonymous"
    ></script>
    <!-- Bulma -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <style>
      * {
        margin: 0px;
        padding: 20px;
      }
      .select * {
        border: none;
      }
      .wrap {
        border: 1px solid gray;
        width: 800px;
        margin: 0 auto;
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .top.columns {
        border: 1px solid gray;
      }
      .column {
        border: 1px solid gray;
      }
    </style>
    {% block function %}{% endblock %}
    <script>
      function drop() {
        $("#dropdown-menu").toggle("is-active");
      }
      const State = {
        POST: "post", // 글 작성 페이지
        MY_DETAIL: "my_detail", // 글 상세 페이지 (본인)
        OTHER_DETAIL: "other_detail", // 글 상세 페이지 (타인)
        UNKNOWN: "unknown", //
      };
      let CurrentState = State.UNKNOWN;

      $(document).ready(function () {
        // alert("페이지가 로딩되었습니다.");
        $("post-list").html(""); // 포스트 페이지를 한 번 싹 지우고
        if (CurrentState == State.POST) showReviewPost();
        else if (CurrentState == State.MY_DETAIL) showMyDetail();
        else if (CurrentState == State.OTHER_DETAIL) showOtherDetail();
        // else showUnknownState(); 어떤 페이지를 열지 안왔을 때
      });

      function likeReview(id) {
        $.ajax({
          type: "POST",
          url: "/like",
          data: { id: id, },
          success: function (response) {
            if (response["result"] == "success") {
              // 2. '좋아요 완료!' 얼럿을 띄웁니다.
              alert("좋아요 완료!");
              window.location.reload();
            } else {
              alert("좋아요 실패ㅠㅠ");
            }
          },
        });
      }

      function favoriteReview(id) {
        $.ajax({
          type: "POST",
          url: "/favorite",
          data: { id: id },
          success: function (response) {
            if (response["result"] == "success") {
              // 2. '좋아요 완료!' 얼럿을 띄웁니다.
              alert("즐겨찾기 추가 완료!");
              // 3. 변경된 정보를 반영하기 위해 새로고침합니다. 구현해야함.
            } else if (response["result"] == "existed") {
              alert("이미 즐겨찾기 내역에 존재합니다.");
            } else {
              alert("즐겨찾기 추가 실패ㅠㅠ");
            }
          },
        });
      }
      function deleteReview(id) {
        $.ajax({
          type: "POST",
          url: "/delete",
          data: { id: id },
          success: function (response) {
            if (response["result"] == "success") {
              // 2. '삭제되었습니다!' 얼럿을 띄웁니다.
              alert("리뷰가 삭제되었습니다!");
              // 3. 변경된 정보를 반영하기 위해 새로고침합니다.
            } else {
              alert("리뷰 삭제 실패ㅠㅠ");
            }
          },
        });
      }

      function postReview() {
        // 작성 버튼
        let restaurant = $("#restaurant").val(); // 음식점 이름 불러오기
        let category = $("select > option:selected").val();
        let comment = $("#review").val(); // 리뷰글 불러오기
        $.ajax({
          type: "POST",
          url: "/post/mydetail",
          data: {
            restaurant_give: restaurant,
            category_give: category,
            comment_give: comment,
          },
          success: function (response) {
            if (response["result"] == "success") {
              alert("성공!");
              window.location.href="/mydetail";
              // 글 상세 페이지 (본인) 으로 이동하는 부분. id와 연관시키는 것이 필요하다.
            } else if (response["result"] == "empty") {
              alert("제목, 평가글, 카테고리를 모두 채워주세요!");
            } else {
              alert("작성 실패!");
              // 초기화하기
            }
          },
        });
      }

      function showMyDetail() {
        $.ajax({
          type: "GET",
          url: "/review/mydetail",
          data: {},
          success: function (response) {
            if (response["result"] != "success") {
              // ?
              return;
            } else {
              alert("불러오기 실패!");
            }
          },
        });
      }
      function showOtherDetail() {
        $.ajax({
          type: "GET",
          url: "/review/otherdetail",
          data: {},
          success: function (response) {
            if (response["result"] != "success") {
              // ?
              return;
            } else {
              alert("불러오기 실패!");
            }
          },
        });
      }
      
      function modifyReview(id) {
        // 작성 버튼
        let restaurant = $("#restaurant").val(); // 음식점 이름 불러오기
        let category = $("select > option:selected").val();
        let comment = $("#review").val(); // 리뷰글 불러오기
        $.ajax({
          type: "POST",
          url: "/modify/mydetail",
          data: {
            restaurant_give: restaurant,
            category_give: category,
            comment_give: comment,
            id_give: id,
          },
          success: function (response) {
            if (response["result"] == "success") {
              alert("수정 성공!");
              // 글 상세 페이지 (본인) 으로 이동하는 부분 추가하기
            } else if (response["result"] == "empty") {
              alert("제목, 평가글, 카테고리를 모두 채워주세요!");
            } else {
              alert("수정 사항이 없습니다!");
              // 초기화하기
            }
          },
        });
      }

    </script>
  </head>
  <!-- 글 작성, 상세(본인, 타인) 페이지 -->
  <body>
    <div class="wrap card" id="post-list">
      <div class="card-content">
        <p class="title">
          {% block post_title %}{% endblock %}
          {% block favorites %}{% endblock %}
        </p>
        <div class="top columns">
          <div class="column is-two-thirds">
            {# 음식점 이름 #}
            {% block restaurant_input %}{% endblock %}
            {# 카테고리 드롭다운 #}
            {% block select %} {% endblock %}
            {# db에서 위치 정보 #}
            {% block lodation%} {%endblock%}
          </div>
          {# 사진 정보 #}
          <div class="column">사진</div>
        </div>
      </div>
      <!-- 글 작성 페이지, 글 수정 페이지일 때만 사진 업로드 가능-->
      {% block upload_image %}{% endblock %}
      <!-- 글 작성 페이지, 글 수정 페이지일 때만 textarea 작성 가능-->
      {% block post_textarea %}{% endblock %}
      <footer class="card-footer">
        <!-- 글 작성 페이지일 때만 작성버튼 표시 -->
        {% block post_button %}{% endblock %}
        <!-- 글 상세 페이지(본인)일 때만 수정, 삭제 버튼 표시 -->
        <section id="mydetail_button">
          {% block mydetail_button %}{% endblock %}
        </section>
        <!-- 글 상세 페이지(타인)일 때만 좋아요 버튼, 좋아요 수 표시 -->
        {% block like_button %}{% endblock %}
        <!-- <button>좋아요 <span>좋아요 수</span></button> -->
        <button class="button is-dark" onclick="location.href='/'">
          <!-- 나중에 경로 다시 설정 -->
          나가기
        </button>
      </footer>
    </div>
    {%block jinja_test%}{%endblock%}
  </body>
</html>